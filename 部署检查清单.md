# 公网部署检查清单

## 1. 服务器配置 ✅
- [x] 已修改监听地址为 `0.0.0.0`（允许公网访问）

## 2. 防火墙配置

### Linux 服务器（使用 firewalld）
```bash
# 查看防火墙状态
sudo systemctl status firewalld

# 开放端口 9988
sudo firewall-cmd --permanent --add-port=9988/tcp
sudo firewall-cmd --reload

# 验证端口是否开放
sudo firewall-cmd --list-ports
```

### Linux 服务器（使用 ufw）
```bash
# 开放端口 9988
sudo ufw allow 9988/tcp
sudo ufw reload

# 查看状态
sudo ufw status
```

### Linux 服务器（使用 iptables）
```bash
# 开放端口 9988
sudo iptables -A INPUT -p tcp --dport 9988 -j ACCEPT
sudo iptables-save
```

## 3. 云服务器安全组配置

### 阿里云 ECS
1. 登录阿里云控制台
2. 进入 ECS 实例详情
3. 点击「安全组」→「配置规则」
4. 添加入站规则：
   - 协议类型：自定义 TCP
   - 端口范围：9988/9988
   - 授权对象：0.0.0.0/0（允许所有IP访问）
   - 描述：基金计算器服务

### 腾讯云 CVM
1. 登录腾讯云控制台
2. 进入 CVM 实例详情
3. 点击「安全组」→「修改规则」
4. 添加入站规则：
   - 类型：自定义
   - 协议端口：TCP:9988
   - 来源：0.0.0.0/0
   - 策略：允许

### 其他云服务器
类似配置，确保在安全组/防火墙规则中开放端口 9988

## 4. 服务器启动验证

### 检查服务器是否在监听
```bash
# 查看端口占用情况
netstat -tlnp | grep 9988
# 或
ss -tlnp | grep 9988

# 应该看到类似输出：
# LISTEN  0  128  0.0.0.0:9988  0.0.0.0:*
```

### 在服务器本地测试
```bash
# 在服务器上测试本地访问
curl http://localhost:9988

# 测试 API 接口
curl http://localhost:9988/api/fund/161725
```

### 从公网测试
```bash
# 在本地电脑上测试（替换为实际服务器IP）
curl http://<服务器公网IP>:9988

# 测试 API 接口
curl http://<服务器公网IP>:9988/api/fund/161725
```

## 5. 常见问题排查

### 问题1：无法连接（Connection refused）
- **原因**：防火墙或安全组未开放端口
- **解决**：按照上面的步骤配置防火墙和安全组

### 问题2：连接超时（Connection timeout）
- **原因**：服务器防火墙阻止了连接，或安全组规则未生效
- **解决**：
  1. 检查服务器防火墙状态
  2. 检查云服务器安全组规则
  3. 确认服务器公网IP是否正确

### 问题3：可以连接但返回 404
- **原因**：服务器正常运行，但请求路径不正确
- **解决**：
  1. 确认访问路径正确：`http://<IP>:9988/` 或 `http://<IP>:9988/fund_calculator.html`
  2. 检查 HTML 文件是否存在

### 问题4：可以访问页面但 API 请求失败
- **原因**：代理配置问题或基金 API 无法访问
- **解决**：
  1. 检查服务器网络是否正常
  2. 测试服务器是否能访问基金 API：`curl https://fundgz.1234567.com.cn/js/161725.js`
  3. 查看服务器日志排查错误

## 6. 使用 PM2 保持服务运行（推荐）

### 安装 PM2
```bash
npm install -g pm2
```

### 启动服务
```bash
pm2 start proxy-server.js --name fund-calculator
```

### 查看状态
```bash
pm2 status
pm2 logs fund-calculator
```

### 设置开机自启
```bash
pm2 startup
pm2 save
```

## 7. 使用 systemd 保持服务运行（可选）

创建服务文件 `/etc/systemd/system/fund-calculator.service`：
```ini
[Unit]
Description=Fund Calculator Service
After=network.target

[Service]
Type=simple
User=your-username
WorkingDirectory=/path/to/money
ExecStart=/usr/bin/node /path/to/money/proxy-server.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable fund-calculator
sudo systemctl start fund-calculator
sudo systemctl status fund-calculator
```

## 8. 验证部署成功

访问以下地址验证：
- 主页：`http://<服务器公网IP>:9988/`
- 基金计算器：`http://<服务器公网IP>:9988/fund_calculator.html`
- API 测试：`http://<服务器公网IP>:9988/api/fund/161725`

如果都能正常访问，说明部署成功！

